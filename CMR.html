<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D Gesture Particle Sphere</title>

<!-- THREE -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

<style>
body{
  margin:0;
  background:#0d1117;
  font-family:system-ui;
  overflow:hidden;
  color:#fff;
}

/* ------- UI ------- */
#ui{
  position:fixed;
  top:16px;
  left:16px;
  background:#161b22;
  border-radius:16px;
  padding:12px 16px;
  box-shadow:0 10px 30px rgba(0,0,0,.4);
  display:flex;
  gap:10px;
  align-items:center;
  z-index:5;
}
#color{
  width:36px;
  height:36px;
  border:none;
  border-radius:8px;
}
#status{
  opacity:.9;
  font-size:14px;
}

/* video preview */
#video{
  position:fixed;
  bottom:16px;
  right:16px;
  width:240px;
  border-radius:14px;
  opacity:.3;
  z-index:1;
  transform:scaleX(-1);
}

canvas{
  display:block;
  position:relative;
  z-index:2;
}
</style>
</head>

<body>

<div id="ui">
  <label>M√†u h·∫°t:</label>
  <input type="color" id="color" value="#00aaff">
  <div id="status">ƒêang ch·ªù tay‚Ä¶</div>
</div>

<video id="video" autoplay playsinline></video>

<script>
/* =========================
   THREE.JS
========================= */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0,0,4);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
renderer.setClearColor("#0d1117");
document.body.appendChild(renderer.domElement);

/* ---------------------
   PARTICLES
--------------------- */
const COUNT = 4000;
let basePos = new Float32Array(COUNT*3);

for(let i=0;i<COUNT;i++){
  const u = Math.random();
  const v = Math.random();
  const theta = 2*Math.PI*u;
  const phi = Math.acos(2*v-1);

  const x = Math.sin(phi)*Math.cos(theta);
  const y = Math.sin(phi)*Math.sin(theta);
  const z = Math.cos(phi);

  basePos[i*3]   = x;
  basePos[i*3+1] = y;
  basePos[i*3+2] = z;
}

let geo = new THREE.BufferGeometry();
geo.setAttribute("position", new THREE.BufferAttribute(basePos,3));

let material = new THREE.PointsMaterial({
  size:0.05,
  color:"#00aaff"
});

let pts = new THREE.Points(geo,material);
scene.add(pts);

/* color picker */
document.getElementById("color").addEventListener("input",e=>{
  material.color.set(e.target.value);
});

/* resize */
addEventListener("resize",()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

/* =========================
   HAND TRACKING
========================= */
const video = document.getElementById("video");

let targetRadius = 1.2;
let currentRadius = 1.2;

const hands = new Hands({
  locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});

hands.setOptions({
  selfieMode:true,
  maxNumHands:2,
  modelComplexity:1,
  minDetectionConfidence:0.5,
  minTrackingConfidence:0.5
});

hands.onResults(results=>{
  if(results.multiHandLandmarks && results.multiHandLandmarks.length>0){

    let dists=[];

    results.multiHandLandmarks.forEach(hand=>{
      const a = hand[4];
      const b = hand[8];
      const dx=a.x-b.x, dy=a.y-b.y, dz=a.z-b.z;
      dists.push(Math.sqrt(dx*dx+dy*dy+dz*dz));
    });

    const avg = dists.reduce((a,b)=>a+b,0)/dists.length;

    console.log("distance:", avg);   // üëà th√™m d√≤ng n√†y

    targetRadius = THREE.MathUtils.clamp(
      THREE.MathUtils.mapLinear(avg,0.03,0.2,1,4),
      1,4
    );
  }
});


/* camera */
const cam = new Camera(video,{
  onFrame: async()=>{
    await hands.send({image:video});
  },
  width:640,
  height:480
});
cam.start();

/* =========================
   ANIMATION
========================= */
function animate(){
  requestAnimationFrame(animate);

  currentRadius += (targetRadius-currentRadius)*0.1;

  const pos = geo.attributes.position.array;
  for(let i=0;i<COUNT;i++){
    const ix=i*3;
    pos[ix]   = basePos[ix]   * currentRadius;
    pos[ix+1] = basePos[ix+1] * currentRadius;
    pos[ix+2] = basePos[ix+2] * currentRadius;
  }

  geo.attributes.position.needsUpdate = true;

  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>

